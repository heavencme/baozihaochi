{"name":"email-verification","version":"0.4.6","description":"Verify email sign-up using MongoDB.","main":"index.js","scripts":{"format:examples":"js-beautify -r examples/**/*.js","format:main":"js-beautify -r index.js","format:test":"js-beautify -s 2 -r test/*.js","format":"npm run format:main && npm run format:examples && npm run format:test","lint:examples":"jshint --reporter=node_modules/jshint-stylish examples/**/*.js","lint:main":"jshint --reporter=node_modules/jshint-stylish index.js","lint:test":"jshint --reporter=node_modules/jshint-stylish test/*.js","lint":"npm run lint:main && npm run lint:examples && npm run lint:test","test":"mocha"},"repository":{"type":"git","url":"git+https://github.com/whitef0x0/node-email-verification.git"},"keywords":["mongodb","auth","authentication","email"],"author":{"name":"Dakota St. Laurent","email":"hello@saintdako.com","url":"http://saintdako.com/"},"contributors":[{"name":"David Baldwynn","email":"polydaic@gmail.com","url":"https://github.com/whitef0x0"},{"name":"Frank Cash","email":"cashc@acm.org","url":"https://github.com/frankcash"}],"license":"ISC","bugs":{"url":"https://github.com/whitef0x0/node-email-verification/issues"},"homepage":"http://email-verification.xyz/","dependencies":{"mongoose":"~3.8.0","nodemailer":"^4.0.1","rand-token":"^0.2.1"},"devDependencies":{"async":"^1.4.2","bcryptjs":"^2.3.0","body-parser":"^1.9.3","chai":"*","express":"^4.10.4","js-beautify":"^1.5.10","jshint":"*","jshint-stylish":"*","mocha":"*","nodemailer-stub-transport":"^1.0.0","bluebird":"*"},"gitHead":"8b179f34e0943c389b2058c9ec1e6d2135a72857","readme":"# <img src=\"https://github.com/whitef0x0/node-email-verification/raw/master/design/logo.png\" data-canonical-src=\"https://github.com/whitef0x0/node-email-verification/raw/master/design/logo.png\" width=\"48\"/> Node Email Verification\n\n[![Build Status](https://travis-ci.org/whitef0x0/node-email-verification.svg?branch=master)](https://travis-ci.org/whitef0x0/node-email-verification)\n[![Code Climate](https://codeclimate.com/github/whitef0x0/node-email-verification/badges/gpa.svg)](https://codeclimate.com/github/whitef0x0/node-email-verification)\n[![Codacy Badge](https://api.codacy.com/project/badge/Grade/dad0c103e43e4ac79a118ea5bd0537dd)](https://www.codacy.com/app/david-baldwin/node-email-verification?utm_source=github.com&amp;utm_medium=referral&amp;utm_content=whitef0x0/node-email-verification&amp;utm_campaign=Badge_Grade)\n[![Gitter](https://badges.gitter.im/whitef0x0/node-email-verification.svg)](https://gitter.im/whitef0x0/node-email-verification?utm_source=badge&utm_medium=badge&utm_campaign=pr-badge)\n\n[![NPM](https://nodei.co/npm/email-verification.png?downloads=true&downloadRank=true&stars=true)](https://nodei.co/npm/email-verification/)\n\n[See documentation and setup here](http://whitef0x0.github.io/node-email-verification)\n\nVerify user signup over email with NodeJS and MongoDB!\n\nThe way this works is as follows:\n\n- temporary user is created with a randomly generated URL assigned to it and then saved to a MongoDB collection\n- email is sent to the email address the user signed up with\n- when the URL is accessed, the user's data is transferred to the real collection\n\nA temporary user document has a TTL of 24 hours by default, but this (as well as many other things) can be configured. See the options section for more details. It is also possible to resend the verification email if needed.\n\n## Installation\nvia npm:\n\n```\nnpm install email-verification\n```\n\n## Quick Example/Guide\n\n**Before you start, make sure you have a directory structure like so:**\n```\napp/\n-- userModel.js\n-- tempUserModel.js\nnode_modules/\nserver.js\n```\n\n### Step 1: Add your dependencies\nAll of the code in this section takes place in server.js. Note that `mongoose` has to be passed as an argument when requiring the module:\n\n```javascript\nvar User = require('./app/userModel'),\n    mongoose = require('mongoose'),\n    nev = require('email-verification')(mongoose);\nmongoose.connect('mongodb://localhost/YOUR_DB');\n```\n\n### Step 2: Configure your settings\nNext, make sure to configure the options (see the section below for more extensive detail on this):\n\n```javascript\nnev.configure({\n    verificationURL: 'http://myawesomewebsite.com/email-verification/${URL}',\n    persistentUserModel: User,\n    tempUserCollection: 'myawesomewebsite_tempusers',\n\n    transportOptions: {\n        service: 'Gmail',\n        auth: {\n            user: 'myawesomeemail@gmail.com',\n            pass: 'mysupersecretpassword'\n        }\n    },\n    verifyMailOptions: {\n        from: 'Do Not Reply <myawesomeemail_do_not_reply@gmail.com>',\n        subject: 'Please confirm account',\n        html: 'Click the following link to confirm your account:</p><p>${URL}</p>',\n        text: 'Please confirm your account by clicking the following link: ${URL}'\n    }\n}, function(error, options){\n});\n```\n\nNote: Any options not included in the object you pass will take on the default value specified in the section below. Calling `configure` multiple times with new options will simply change the previously defined options.\n\n### Step 3: Create a Temporary user Model\nTo create a temporary user model, you can either generate it using a built-in function, or you can predefine it in a separate file. If you are pre-defining it, it must be IDENTICAL to the user model with an extra field for the URL; the default one is `GENERATED_VERIFYING_URL: String`.\n\n```javascript\n// configuration options go here...\n\n// generating the model, pass the User model defined earlier\nnev.generateTempUserModel(User);\n\n// using a predefined file\nvar TempUser = require('./app/tempUserModel');\nnev.configure({\n    tempUserModel: TempUser\n}, function(error, options){\n});\n```\n\n### Step 4: Create a TempUser Model in your Signup Handler\nThen, create an instance of the User model, and then pass it as well as a custom callback to `createTempUser`. Inside your `createTempUser` callback, make a call to the `sendVerificationEmail` function.\n\n```javascript\n// get the credentials from request parameters or something\nvar email = \"...\",\n    password = \"...\";\n\nvar newUser = User({\n    email: email,\n    password: password\n});\n\nnev.createTempUser(newUser, function(err, existingPersistentUser, newTempUser) {\n    // some sort of error\n    if (err)\n        // handle error...\n\n    // user already exists in persistent collection...\n    if (existingPersistentUser)\n        // handle user's existence... violently.\n\n    // a new user\n    if (newTempUser) {\n        var URL = newTempUser[nev.options.URLFieldName];\n        nev.sendVerificationEmail(email, URL, function(err, info) {\n            if (err)\n                // handle error...\n\n            // flash message of success\n        });\n\n    // user already exists in temporary collection...\n    } else {\n        // flash message of failure...\n    }\n});\n```\n\n### Step 4.5: Hash your users password\nNote: An email will be sent to the email address that the user signed up with. If you are interested in hashing the password (which you probably should be), all you need to do is set the option `hashingFunction` to a function that takes the parameters `password, tempUserData, insertTempUser, callback` and returns `insertTempUser(hash, tempUserData, callback)`, e.g.:\n\n```javascript\n// sync version of hashing function\nvar myHasher = function(password, tempUserData, insertTempUser, callback) {\n  var hash = bcrypt.hashSync(password, bcrypt.genSaltSync(8), null);\n  return insertTempUser(hash, tempUserData, callback);\n};\n\n// async version of hashing function\nmyHasher = function(password, tempUserData, insertTempUser, callback) {\n  bcrypt.genSalt(8, function(err, salt) {\n    bcrypt.hash(password, salt, function(err, hash) {\n      return insertTempUser(hash, tempUserData, callback);\n    });\n  });\n};\n```\n\n### Step 5: Confirm your user and save your user to persistent storage\nTo move a user from the temporary storage to 'persistent' storage (e.g. when they actually access the URL we sent them), we call `confirmTempUser`, which takes the URL as well as a callback with two parameters: an error, and the instance of the User model (or `null` if there are any errors, or if the user wasn't found - i.e. their data expired).\n\nIf you want to send a confirmation email, note that in your options the `shouldSendConfirmation` default value is true, which means that on calling `confirmTempUser` you will automatically send a confirmation e-mail. Creating a call to `sendConfirmationEmail` will end up sending two confirmation e-mails to the user. In your configurations, you should either have `shouldSendConfirmation` equal true or use `sendConfirmationEmail`.\n\nIf `shouldSendConfirmation` is false and you want to send a confirmation email, you need to make a call to the `sendConfirmationEmail` function, inside the `confirmTempUser` callback, which takes two parameters: the user's email and a callback. This callback takes two parameters: an error if any occured, and the information returned by Nodemailer.\n\n```javascript\nvar url = '...';\nnev.confirmTempUser(url, function(err, user) {\n    if (err)\n        // handle error...\n\n    // user was found!\n    if (user) {\n        // optional\n        nev.sendConfirmationEmail(user['email_field_name'], function(err, info) {\n            // redirect to their profile...\n        });\n    }\n\n    // user's data probably expired...\n    else\n        // redirect to sign-up\n});\n```\n\n### Step 5.5: Allow user to resend verification email\nIf you want the user to be able to request another verification email, simply call `resendVerificationEmail`, which takes the user's email address and a callback with two parameters: an error, and a boolean representing whether or not the user was found.\n\n```javascript\nvar email = '...';\nnev.resendVerificationEmail(email, function(err, userFound) {\n    if (err)\n        // handle error...\n\n    if (userFound)\n        // email has been sent\n    else\n        // flash message of failure...\n});\n```\n\nTo see a fully functioning example that uses Express as the backend, check out the [**examples section**](https://github.com/SaintDako/node-email-verification/tree/master/examples/express).\n\n**NEV supports Bluebird's PromisifyAll!** Check out the examples section for that too.\n\n## API\n* [`configure`](#configure)\n* [`generateTempUserModel`](#generateTempUserModel)\n* [`createTempUser`](#createTempUser)\n* [`sendVerificationEmail`](#sendVerificationEmail)\n* [`confirmTempUser`](#confirmTempUser)\n* [`sendConfirmationEmail`](#Options)\n* [`resendVerificationEmail`](#resendVerificationEmail)\n* [`Options`](#Options)\n\n<a name=\"configure\"></a>\n### `configure(optionsToConfigure, callback(err, options))`\nChanges the default configuration by passing an object of options to configure (`optionsToConfigure`); see the section below for a list of all options. `options` will be the result of the configuration, with the default values specified below if they were not given. If there are no errors, `err` is `null`.\n\n<a name=\"generateTempUserModel\"></a>\n### `generateTempUserModel(UserModel, callback(err, tempUserModel))`\nGenerates a Mongoose Model for the temporary user based off of `UserModel`, the persistent user model. The temporary model is essentially a duplicate of the persistent model except that it has the field `{GENERATED_VERIFYING_URL: String}` for the randomly generated URL by default (the field name can be changed in the options). If the persistent model has the field `createdAt`, then an expiration time (`expires`) is added to it with a default value of 24 hours; otherwise, the field is created as such:\n\n```javascript\n{\n    ...\n    createdAt: {\n        type: Date,\n        expires: 86400,\n        default: Date.now\n    }\n    ...\n}\n```\n\n`tempUserModel` is the Mongoose model that is created for the temporary user. If there are no errors, `err` is `null`.\n\nNote that `createdAt` will not be transferred to persistent storage (yet?).\n\n<a name=\"createTempUser\"></a>\n### `createTempUser(user, callback(err, newTempUser))`\nAttempts to create an instance of a temporary user model based off of an instance of a persistent user, `user`, and add it to the temporary collection. `newTempUser` is the temporary user instance if the user doesn't exist in the temporary collection, or `null` otherwise. If there are no errors, `err` is `null`.\n\nIf a temporary user model hasn't yet been defined (generated or otherwise), `err` will NOT be `null`.\n\n<a name=\"sendVerificationEmail\"></a>\n### `sendVerificationEmail(email, url, callback(err, info))`\nSends a verification email to to the email provided, with a link to the URL to verify the account. If sending the email succeeds, then `err` will be `null` and `info` will be some value. See [Nodemailer's documentation](https://github.com/andris9/Nodemailer#sending-mail) for information.\n\n<a name=\"confirmTempUser\"></a>\n### `confirmTempUser(url, callback(err, newPersistentUser))`\nTransfers a temporary user (found by `url`) from the temporary collection to the persistent collection and removes the URL assigned with the user. `newPersistentUser` is the persistent user instance if the user has been successfully transferred (i.e. the user accessed URL before expiration) and `null` otherwise; this can be used for redirection and what not. If there are no errors, `err` is `null`.\n\n<a name=\"sendConfirmationEmail\"></a>\n### `sendConfirmationEmail(email, callback(err, info))`\nSends a confirmation email to to the email provided. If sending the email succeeds, then `err` will be `null` and `info` will be some value. See [Nodemailer's documentation](https://github.com/andris9/Nodemailer#sending-mail) for information.\n\n<a name=\"resendVerificationEmail\"></a>\n### `resendVerificationEmail(email, callback(err, userFound))`\nResends the verification email to a user, given their email. `userFound` is `true` if the user has been found in the temporary collection (i.e. their data hasn't expired yet) and `false` otherwise. If there are no errors, `err` is `null`.\n\n<a name=\"Options\"></a>\n## Options\nHere are the default options:\n\n```javascript\nvar options = {\n    verificationURL: 'http://example.com/email-verification/${URL}',\n    URLLength: 48,\n\n    // mongo-stuff\n    persistentUserModel: null,\n    tempUserModel: null,\n    tempUserCollection: 'temporary_users',\n    emailFieldName: 'email',\n    passwordFieldName: 'password',\n    URLFieldName: 'GENERATED_VERIFYING_URL',\n    expirationTime: 86400,\n\n    // emailing options\n    transportOptions: {\n        service: 'Gmail',\n        auth: {\n            user: 'user@gmail.com',\n            pass: 'password'\n        }\n    },\n    verifyMailOptions: {\n        from: 'Do Not Reply <user@gmail.com>',\n        subject: 'Confirm your account',\n        html: '<p>Please verify your account by clicking <a href=\"${URL}\">this link</a>. If you are unable to do so, copy and ' +\n                'paste the following link into your browser:</p><p>${URL}</p>',\n        text: 'Please verify your account by clicking the following link, or by copying and pasting it into your browser: ${URL}'\n    },\n    shouldSendConfirmation: true,\n    confirmMailOptions: {\n        from: 'Do Not Reply <user@gmail.com>',\n        subject: 'Successfully verified!',\n        html: '<p>Your account has been successfully verified.</p>',\n        text: 'Your account has been successfully verified.'\n    },\n\n    hashingFunction: null,\n}\n```\n\n- **verificationURL**: the URL for the user to click to verify their account. `${URL}` determines where the randomly generated part of the URL goes, and is needed. Required.\n- **URLLength**: the length of the randomly-generated string. Must be a positive integer. Required.\n\n- **persistentUserModel**: the Mongoose Model for the persistent user.\n- **tempUserModel**: the Mongoose Model for the temporary user. you can generate the model by using `generateTempUserModel` and passing it the persistent User model you have defined, or you can define your own model in a separate file and pass it as an option in `configure` instead.\n- **tempUserCollection**: the name of the MongoDB collection for temporary users.\n- **emailFieldName**: the field name for the user's email. If the field is nested within another object(s), use dot notation to access it, e.g. `{local: {email: ...}}` would use `'local.email'`. Required.\n- **passwordFieldName**: the field name for the user's password. If the field is nested within another object(s), use dot notation to access it (see above). Required.\n- **URLFieldName**: the field name for the randomly-generated URL. Required.\n- **expirationTime**: the amount of time that the temporary user will be kept in collection, measured in seconds. Must be a positive integer. Required.\n\n- **transportOptions**: the options that will be passed to `nodemailer.createTransport`.\n- **verifyMailOptions**: the options that will be passed to `nodemailer.createTransport({...}).sendMail` when sending an email for verification. You must include `${URL}` somewhere in the `html` and/or `text` fields to put the URL in these strings.\n- **shouldSendConfirmation**: send an email upon the user verifiying their account to notify them of verification.\n- **confirmMailOptions**: the options that will be passed to `nodemailer.createTransport({...}).sendMail` when sending an email to notify the user that their account has been verified. You must include `${URL}` somewhere in the `html` and/or `text` fields to put the URL in these strings.\n\n- **hashingFunction**: the function that hashes passwords. Must take four parameters `password, tempUserData, insertTempUser, callback` and return `insertTempUser(hash, tempUserData, callback)`.\n\n### Development\nTo beautify the code:\n\n```\nnpm run format:main\nnpm run format:examples\nnpm run format:test\nnpm run format  # runs all\n```\n\nTo lint the code (will error if there are any warnings):\n\n```\nnpm run lint:main\nnpm run lint:examples\nnpm run lint:test\nnpm run lint  # runs all\n```\n\nTo test:\n\n```\nnpm test\n```\n\n### Acknowledgements\nthanks to [Dakota St. Lauren](https://github.com/SaintDako) for starting this project\nthanks to [Frank Cash](https://github.com/frankcash) for looking over the code and adding tests.\n\n### license\nISC\n","readmeFilename":"README.md","_id":"email-verification@0.4.6","_shasum":"7d0f83b9ba219a4a3308e9bc47610632754c4d66","_from":"tellform/node-email-verification","_resolved":"git://github.com/tellform/node-email-verification.git#8b179f34e0943c389b2058c9ec1e6d2135a72857"}